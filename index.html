<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç°½åˆ°ç³»çµ±</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #eef2f5;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            font-family: 'Segoe UI', sans-serif;
        }

        .card {
            max-width: 450px;
            width: 100%;
            border: none;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        .btn-primary {
            width: 100%;
            padding: 12px;
            font-weight: bold;
            font-size: 1.1rem;
            border-radius: 8px;
        }

        .form-control {
            border-radius: 8px;
            padding: 10px;
        }

        .spinner-border {
            display: none;
            width: 1.2rem;
            height: 1.2rem;
            margin-right: 8px;
        }

        .alert-custom {
            font-size: 0.9rem;
            margin-top: 10px;
        }
    </style>
</head>

<body>

    <div class="card p-4 p-md-5">
        <h3 class="text-center mb-4 text-primary fw-bold">ğŸ–¥ï¸ ç¤¾åœ˜ç°½åˆ°</h3>

        <form id="checkinForm">
            <div class="mb-4">
                <label for="password" class="form-label text-danger fw-bold">ç•¶æ—¥å¯†ç¢¼</label>
                <input type="number" class="form-control border-danger" id="password" placeholder="å¯†ç¢¼" required>
            </div>

            <div class="row g-3 mb-3">
                <div class="col-6">
                    <label for="classNo" class="form-label">ç­ç´š</label>
                    <input type="text" class="form-control" id="classNo" placeholder="209" required>
                </div>
                <div class="col-6">
                    <label for="seatNo" class="form-label">åº§è™Ÿ</label>
                    <input type="number" class="form-control" id="seatNo" placeholder="07" required>
                </div>
            </div>

            <div class="mb-3">
                <label for="pcNo" class="form-label fw-bold text-success">é›»è…¦ç·¨è™Ÿ</label>
                <input type="text" class="form-control border-success" id="pcNo" placeholder="ä¾‹å¦‚ï¼š5" required>
            </div>

            <div class="mb-3">
                <label for="studentId" class="form-label">å­¸è™Ÿ</label>
                <input type="text" class="form-control" id="studentId" required>
            </div>

            <div class="mb-4">
                <label for="name" class="form-label">å§“å</label>
                <input type="text" class="form-control" id="name" required>
            </div>

            <button type="submit" class="btn btn-primary" id="submitBtn">
                <span class="spinner-border" role="status"></span>
                é€å‡ºç°½åˆ°
            </button>
        </form>

        <div id="statusMessage" class="mt-4 text-center fw-bold"></div>
    </div>

    <script>
        // â˜…â˜…â˜… è«‹æ›¿æ›æˆä½ çš„ Google Apps Script ç¶²å€ â˜…â˜…â˜…
        const GAS_URL = 'https://script.google.com/macros/s/AKfycby8ZA_9CAovIqLsxt6S_hAsOPmrUApV_csGtCK82PhN1lVcM1rpGJeAbyKDAohkpnsg/exec';

        document.getElementById('checkinForm').addEventListener('submit', function (e) {
            e.preventDefault();

            const btn = document.getElementById('submitBtn');
            const spinner = document.querySelector('.spinner-border');
            const msg = document.getElementById('statusMessage');

            // é–å®šä»‹é¢
            btn.disabled = true;
            spinner.style.display = 'inline-block';
            btn.innerHTML = '<span class="spinner-border" role="status"></span> å®šä½ä¸­...';
            msg.textContent = '';
            msg.className = '';

            // â˜…â˜…â˜… å–å¾— GPS ä½ç½® â˜…â˜…â˜…
            if (!navigator.geolocation) {
                handleError("æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´å®šä½åŠŸèƒ½ï¼Œç„¡æ³•ç°½åˆ°ã€‚");
                return;
            }

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    // å®šä½æˆåŠŸ
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;

                    // é–‹å§‹å–å¾— IP ä¸¦å‚³é€è³‡æ–™
                    getIpAndSend(lat, lng);
                },
                (error) => {
                    // å®šä½å¤±æ•—
                    console.error(error);
                    handleError("ç„¡æ³•å–å¾—ä½ç½®ï¼<br>è«‹å…è¨±ç€è¦½å™¨å­˜å– GPS å®šä½å¾Œå†è©¦ã€‚");
                },
                { enableHighAccuracy: true, timeout: 10000 } // è¨­å®šé«˜ç²¾ç¢ºåº¦ï¼Œ10ç§’é€¾æ™‚
            );

            function getIpAndSend(lat, lng) {
                btn.innerHTML = '<span class="spinner-border" role="status"></span> å–å¾— IP ä¸­...';

                // 1. å–å¾— IP ä½å€ (ä½¿ç”¨ ipify API)
                fetch('https://api.ipify.org?format=json')
                    .then(response => response.json())
                    .then(ipData => {
                        return ipData.ip;
                    })
                    .catch(err => {
                        console.warn('ç„¡æ³•å–å¾— IP:', err);
                        return 'ç„¡æ³•å–å¾— IP';
                    })
                    .then(userIP => {
                        // 2. æº–å‚™å‚³é€è³‡æ–™
                        const payload = {
                            password: document.getElementById('password').value,
                            classNo: document.getElementById('classNo').value,
                            seatNo: document.getElementById('seatNo').value,
                            pcNo: document.getElementById('pcNo').value,
                            studentId: document.getElementById('studentId').value,
                            name: document.getElementById('name').value,
                            ip: userIP, // å‚³é€ IP
                            ua: navigator.userAgent, // å‚³é€è£ç½®è³‡è¨Š (User Agent)
                            lat: lat, // â˜… å‚³é€ç·¯åº¦
                            lng: lng  // â˜… å‚³é€ç¶“åº¦
                        };

                        // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
                        btn.innerHTML = '<span class="spinner-border" role="status"></span> è³‡æ–™å‚³é€ä¸­...';

                        // 3. å‚³é€è‡³ Google Apps Script
                        return fetch(GAS_URL, {
                            method: 'POST',
                            body: JSON.stringify(payload),
                            headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                            redirect: 'follow'
                        });
                    })
                    .then(res => res.json())
                    .then(data => {
                        // 4. è™•ç†å¾Œç«¯å›æ‡‰
                        if (data.result === 'success') {
                            // å¯«å…¥ LocalStorage
                            disableForm('âœ… ç°½åˆ°æˆåŠŸï¼<br><small class="text-muted">å·²ç´€éŒ„ä½ç½®ã€IP èˆ‡ é›»è…¦ç·¨è™Ÿ</small>');
                            msg.classList.add('text-success');
                        } else if (data.result === 'wrong_password') {
                            throw new Error('å¯†ç¢¼éŒ¯èª¤ï¼Œè«‹é‡æ–°è¼¸å…¥ã€‚');
                        } else if (data.result === 'duplicate_pc') {
                            throw new Error(`é›»è…¦ç·¨è™Ÿ <u>${data.pcNo}</u> å·²è¢«ä½¿ç”¨ï¼<br>è«‹å‹¿é‡è¤‡ç°½åˆ°ã€‚`);
                        } else {
                            throw new Error('ç³»çµ±éŒ¯èª¤ï¼š' + (data.error || 'æœªçŸ¥åŸå› '));
                        }
                    })
                    .catch(err => {
                        handleError(err.message);
                    });
            }

            function handleError(message) {
                msg.innerHTML = message;
                msg.className = 'mt-4 text-center fw-bold text-danger';

                // å¦‚æœæ˜¯å¯†ç¢¼éŒ¯ï¼Œæ¸…ç©ºå¯†ç¢¼æ¬„ä½
                if (message.includes('å¯†ç¢¼éŒ¯èª¤')) {
                    document.getElementById('password').value = '';
                    document.getElementById('password').focus();
                }

                // æ¢å¾©æŒ‰éˆ•
                btn.disabled = false;
                btn.innerHTML = 'é€å‡ºç°½åˆ°';
                spinner.style.display = 'none';
            }
        });

        function disableForm(message) {
            document.getElementById('checkinForm').style.display = 'none';
            const msgDiv = document.getElementById('statusMessage');
            msgDiv.innerHTML = message;
            msgDiv.className = 'mt-4 text-center fw-bold text-success';
            if (message.includes('âš ï¸')) msgDiv.className = 'mt-4 text-center fw-bold text-warning';
        }
    </script>

</body>

</html>