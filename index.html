<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç°½åˆ°ç³»çµ±</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
        }

        .card {
            max-width: 400px;
            width: 100%;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            border: none;
        }

        .btn-primary {
            width: 100%;
        }

        /* è¼‰å…¥å‹•ç•« */
        .spinner-border {
            display: none;
            width: 1rem;
            height: 1rem;
            margin-right: 5px;
        }
    </style>
</head>

<body>

    <div class="card p-4">
        <h3 class="text-center mb-4">ğŸ“ ç¤¾åœ˜ç°½åˆ°</h3>

        <form id="checkinForm">
            <div class="mb-3">
                <label for="password" class="form-label text-danger fw-bold">å¯†ç¢¼</label>
                <input type="number" class="form-control border-danger" id="password" placeholder="è«‹è¼¸å…¥ç•¶æ—¥å¯†ç¢¼" required>
            </div>
            <hr>
            <div class="row mb-3">
                <div class="col">
                    <label for="classNo" class="form-label">ç­ç´š</label>
                    <input type="text" class="form-control" id="classNo" placeholder="203" required>
                </div>
                <div class="col">
                    <label for="seatNo" class="form-label">åº§è™Ÿ</label>
                    <input type="number" class="form-control" id="seatNo" placeholder="15" required>
                </div>
            </div>

            <div class="mb-3">
                <label for="pcNo" class="form-label">é›»è…¦ç·¨è™Ÿ</label>
                <input type="text" class="form-control" id="pcNo" placeholder="ä¾‹å¦‚ï¼šA-01 æˆ– 05" required>
            </div>

            <div class="mb-3">
                <label for="studentId" class="form-label">å­¸è™Ÿ</label>
                <input type="text" class="form-control" id="studentId" required>
            </div>

            <div class="mb-3">
                <label for="name" class="form-label">å§“å</label>
                <input type="text" class="form-control" id="name" required>
            </div>

            <button type="submit" class="btn btn-primary" id="submitBtn">
                <span class="spinner-border" role="status"></span>
                é€å‡ºç°½åˆ°
            </button>
        </form>

        <div id="statusMessage" class="mt-3 text-center fw-bold"></div>
    </div>

    <script>
        // ä½ çš„ Apps Script ç¶²å€ (è«‹ç¢ºèªç¶²å€æ­£ç¢º)
        const GAS_URL = 'https://script.google.com/macros/s/AKfycby9f_jlv7pviGuwdOBExjzYX2Vn9XFoL156vT54uVSv8aEAciyirNg7lBWy8ye4co4I/exec';

        // ç¶²é ä¸€è¼‰å…¥å°±æª¢æŸ¥æ˜¯å¦å·²ç°½åˆ°
        if (localStorage.getItem('hasCheckIn') === 'true') {
            document.getElementById('checkinForm').style.display = 'none';
            document.getElementById('statusMessage').textContent = 'âš ï¸ æ­¤è£ç½®å·²å®Œæˆç°½åˆ°ï¼Œè«‹å‹¿é‡è¤‡æäº¤ã€‚';
        }

        document.getElementById('checkinForm').addEventListener('submit', function (e) {
            e.preventDefault();

            const btn = document.getElementById('submitBtn');
            const spinner = document.querySelector('.spinner-border');
            const msg = document.getElementById('statusMessage');

            // é–å®šæŒ‰éˆ•èˆ‡é¡¯ç¤ºå‹•ç•«
            btn.disabled = true;
            spinner.style.display = 'inline-block';
            msg.textContent = '';
            msg.className = 'mt-3 text-center fw-bold'; // é‡ç½®é¡è‰²

            // æ”¶é›†è³‡æ–™ (æ–°å¢ pcNo)
            const payload = {
                password: document.getElementById('password').value,
                classNo: document.getElementById('classNo').value,
                seatNo: document.getElementById('seatNo').value,
                pcNo: document.getElementById('pcNo').value, // æ–°å¢ï¼šé›»è…¦ç·¨è™Ÿ
                studentId: document.getElementById('studentId').value,
                name: document.getElementById('name').value
            };

            fetch(GAS_URL, {
                method: 'POST',
                body: JSON.stringify(payload),
                headers: {
                    'Content-Type': 'text/plain;charset=utf-8'
                },
                redirect: 'follow'
            })
                .then(res => res.json())
                .then(data => {
                    if (data.result === 'success') {
                        // 1. å¯«å…¥ç€è¦½å™¨ç´€éŒ„
                        localStorage.setItem('hasCheckIn', 'true');

                        // 2. éš±è—è¡¨å–®ï¼Œé¡¯ç¤ºæˆåŠŸè¨Šæ¯
                        document.getElementById('checkinForm').style.display = 'none';
                        document.getElementById('statusMessage').innerHTML = 'âœ… ç°½åˆ°å®Œæˆï¼<br>ä¸€å°è£ç½®åƒ…é™ç°½åˆ°ä¸€æ¬¡ã€‚';
                    } else if (data.result === 'wrong_password') {
                        msg.textContent = 'âŒ å¯†ç¢¼éŒ¯èª¤ï¼Œè«‹é‡æ–°è¼¸å…¥ã€‚';
                        msg.classList.add('text-danger');
                        document.getElementById('password').value = '';
                        document.getElementById('password').focus();
                    } else {
                        throw new Error(data.error);
                    }
                })
                .catch(err => {
                    console.error(err);
                    // å¯¬å®¹è™•ç†
                    msg.textContent = 'âœ… ç°½åˆ°æˆåŠŸ (æˆ–ç¶²è·¯å›æ‡‰å»¶é²)';
                    msg.classList.add('text-success');
                    document.getElementById('checkinForm').reset();
                })
                .finally(() => {
                    btn.disabled = false;
                    spinner.style.display = 'none';
                });
        });
    </script>

</body>

</html>