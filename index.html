<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¤¾åœ˜ç°½åˆ°ç³»çµ±</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f0f4f8;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif;
        }

        .card {
            max-width: 480px;
            width: 90%;
            border: none;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
        }

        .btn-primary {
            width: 100%;
            padding: 12px;
            font-weight: 600;
            border-radius: 10px;
            transition: all 0.3s ease;
        }

        .btn-primary:disabled {
            background-color: #a0c4ff;
            border-color: #a0c4ff;
        }

        .form-control {
            border-radius: 8px;
            padding: 12px;
            border: 1px solid #ced4da;
        }

        .form-control:focus {
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.15);
        }

        .spinner-border {
            width: 1.2rem;
            height: 1.2rem;
            vertical-align: middle;
            margin-right: 8px;
        }

        #statusMessage {
            min-height: 24px;
            transition: all 0.3s ease;
        }
    </style>
</head>

<body>

    <div class="card p-4">
        <h3 class="text-center mb-4 text-primary fw-bold">ğŸ–¥ï¸ ç¤¾åœ˜æ´»å‹•ç°½åˆ°</h3>

        <form id="checkinForm">
            <div class="mb-3">
                <label for="password" class="form-label text-danger fw-bold">ä»Šæ—¥ç°½åˆ°å¯†ç¢¼</label>
                <input type="tel" class="form-control border-danger" id="password" placeholder="è«‹è¼¸å…¥å¯†ç¢¼" required>
            </div>

            <div class="row g-3 mb-3">
                <div class="col-6">
                    <label for="classNo" class="form-label">ç­ç´š</label>
                    <input type="tel" class="form-control" id="classNo" pattern="\d{3}" placeholder="ä¾‹å¦‚ 209" required>
                </div>
                <div class="col-6">
                    <label for="seatNo" class="form-label">åº§è™Ÿ</label>
                    <input type="tel" class="form-control" id="seatNo" pattern="\d{1,2}" placeholder="ä¾‹å¦‚ 07" required>
                </div>
            </div>

            <div class="mb-3">
                <label for="pcNo" class="form-label fw-bold text-success">é›»è…¦ç·¨è™Ÿ</label>
                <input type="tel" class="form-control border-success" id="pcNo" pattern="\d+" placeholder="æ¡Œä¸Šçš„è™Ÿç¢¼"
                    required>
            </div>

            <div class="mb-3">
                <label for="studentId" class="form-label">å­¸è™Ÿ</label>
                <input type="tel" class="form-control" pattern="\d{6}" id="studentId" placeholder="6 ä½æ•¸å­å­¸è™Ÿ" required>
            </div>

            <div class="mb-4">
                <label for="name" class="form-label">å§“å</label>
                <input type="text" class="form-control" id="name" placeholder="æ‚¨çš„å…¨å" required>
            </div>

            <button type="submit" class="btn btn-primary" id="submitBtn">
                é€å‡ºç°½åˆ°
            </button>
        </form>

        <div id="statusMessage" class="mt-4 text-center fw-bold"></div>
    </div>

    <script>
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbw_7iBSjp2pCLs9_q69lTzSq_1iDsvgC4X4oO4fj7VjQsyQyPVwgzIFZu28hJPIMt_g/exec';

        document.getElementById('checkinForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            const btn = document.getElementById('submitBtn');
            const msg = document.getElementById('statusMessage');

            // 1. åˆå§‹åŒ–ä»‹é¢ç‹€æ…‹
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border" role="status"></span> è™•ç†ä¸­...';
            msg.innerHTML = '';
            msg.className = 'mt-4 text-center fw-bold';

            try {
                // 2. åŒæ™‚åŸ·è¡Œï¼šå–å¾— GPS å®šä½èˆ‡ å–å¾—ä½¿ç”¨è€… IP (æå‡æ•ˆç‡)
                // ä½¿ç”¨ Promise.all è®“å…©å€‹éåŒæ­¥å‹•ä½œä¸¦è¡Œ
                const [position, userIP] = await Promise.all([
                    // å®šä½ Promise
                    new Promise((resolve, reject) => {
                        if (!navigator.geolocation) {
                            reject(new Error("ç€è¦½å™¨ä¸æ”¯æ´å®šä½"));
                        }
                        navigator.geolocation.getCurrentPosition(resolve, reject, {
                            enableHighAccuracy: true,
                            timeout: 10000
                        });
                    }),
                    // IP Promise
                    fetch('https://api.ipify.org?format=json')
                        .then(res => res.json())
                        .then(data => data.ip)
                        .catch(() => 'ç„¡æ³•å–å¾— IP')
                ]);

                // 3. æ•´ç†å‚³é€è³‡æ–™
                const payload = {
                    password: document.getElementById('password').value,
                    classNo: document.getElementById('classNo').value,
                    seatNo: document.getElementById('seatNo').value,
                    pcNo: document.getElementById('pcNo').value,
                    studentId: document.getElementById('studentId').value,
                    name: document.getElementById('name').value,
                    ip: userIP,
                    ua: navigator.userAgent,
                    lat: position.coords.latitude,
                    lng: position.coords.longitude
                };

                btn.innerHTML = '<span class="spinner-border" role="status"></span> è³‡æ–™ä¸Šå‚³ä¸­...';

                // 4. å‚³é€è‡³ Google Apps Script
                const response = await fetch(GAS_URL, {
                    method: 'POST',
                    body: JSON.stringify(payload),
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    redirect: 'follow'
                });

                if (!response.ok) throw new Error('ä¼ºæœå™¨é€£ç·šå¤±æ•—');

                const data = await response.json();

                // 5. æ ¹æ“šå¾Œç«¯å›å‚³çµæœè™•ç† UI
                if (data.result === 'success') {
                    showSuccess('ç°½åˆ°æˆåŠŸï¼');
                } else if (data.result === 'wrong_password') {
                    throw new Error('å¯†ç¢¼éŒ¯èª¤ï¼Œè«‹é‡æ–°ç¢ºèªã€‚');
                } else if (data.result === 'duplicate_pc') {
                    throw new Error(`é›»è…¦ç·¨è™Ÿ ${data.pcNo} å·²ç¶“ç°½åˆ°éäº†ï¼`);
                } else {
                    throw new Error('ç™¼ç”ŸéŒ¯èª¤ï¼š' + (data.error || 'æœªçŸ¥åŸå› '));
                }

            } catch (error) {
                // è™•ç†æ‰€æœ‰å¯èƒ½çš„éŒ¯èª¤ (GPS å¤±æ•—ã€ç¶²è·¯å¤±æ•—ã€å¯†ç¢¼éŒ¯èª¤)
                let errorText = error.message;

                // é‡å° Geolocation éŒ¯èª¤ç¢¼é€²è¡Œå‹å–„æç¤º
                if (error.code === 1) errorText = "è«‹å…è¨±ç€è¦½å™¨å­˜å– GPS å®šä½ï¼Œå¦å‰‡ç„¡æ³•ç°½åˆ°ã€‚";
                if (error.code === 3) errorText = "å®šä½é€¾æ™‚ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–é‡è©¦ã€‚";

                handleError(errorText);
            }
        });

        function showSuccess(message) {
            document.getElementById('checkinForm').style.display = 'none';
            const msgDiv = document.getElementById('statusMessage');
            msgDiv.innerHTML = message;
            msgDiv.className = 'mt-4 text-center fw-bold text-success';
        }

        function handleError(message) {
            const btn = document.getElementById('submitBtn');
            const msg = document.getElementById('statusMessage');

            msg.innerHTML = message;
            msg.className = 'mt-4 text-center fw-bold text-danger';

            // å¦‚æœæ˜¯å¯†ç¢¼éŒ¯ï¼Œé‡è¨­å¯†ç¢¼æ¬„ä½
            if (message.includes('å¯†ç¢¼')) {
                document.getElementById('password').value = '';
                document.getElementById('password').focus();
            }

            // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
            btn.disabled = false;
            btn.innerHTML = 'é‡æ–°é€å‡ºç°½åˆ°';
        }
    </script>

</body>

</html>