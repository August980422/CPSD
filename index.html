<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¤¾åœ˜ç°½åˆ°ç³»çµ±</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #eef2f5;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            font-family: 'Segoe UI', sans-serif;
        }

        .card {
            max-width: 450px;
            width: 100%;
            border: none;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        .btn-primary {
            width: 100%;
            padding: 12px;
            font-weight: bold;
            font-size: 1.1rem;
            border-radius: 8px;
        }

        .form-control {
            border-radius: 8px;
            padding: 10px;
        }

        .spinner-border {
            display: none;
            width: 1.2rem;
            height: 1.2rem;
            margin-right: 8px;
        }

        .alert-custom {
            font-size: 0.9rem;
            margin-top: 10px;
        }
    </style>
</head>

<body>

    <div class="card p-4 p-md-5">
        <h3 class="text-center mb-4 text-primary fw-bold">ğŸ–¥ï¸ ç¤¾åœ˜ç°½åˆ°</h3>

        <form id="checkinForm">
            <div class="mb-4">
                <label for="password" class="form-label text-danger fw-bold">ğŸ”‘ ç•¶æ—¥å¯†ç¢¼</label>
                <input type="number" class="form-control border-danger" id="password" placeholder="è€å¸«å…¬å¸ƒçš„å¯†ç¢¼" required>
            </div>

            <div class="row g-3 mb-3">
                <div class="col-6">
                    <label for="classNo" class="form-label">ç­ç´š</label>
                    <input type="text" class="form-control" id="classNo" placeholder="203" required>
                </div>
                <div class="col-6">
                    <label for="seatNo" class="form-label">åº§è™Ÿ</label>
                    <input type="number" class="form-control" id="seatNo" placeholder="15" required>
                </div>
            </div>

            <div class="mb-3">
                <label for="pcNo" class="form-label fw-bold text-success">é›»è…¦ç·¨è™Ÿ</label>
                <input type="text" class="form-control border-success" id="pcNo" placeholder="ä¾‹å¦‚ï¼šA-05 (è«‹çœ‹ä¸»æ©Ÿæˆ–è¢å¹•)"
                    required>
                <div class="form-text text-muted">è«‹å‹™å¿…å¡«å¯«æ­£ç¢ºï¼Œé‡è¤‡å¡«å¯«å°‡ç„¡æ³•ç°½åˆ°ã€‚</div>
            </div>

            <div class="mb-3">
                <label for="studentId" class="form-label">å­¸è™Ÿ</label>
                <input type="text" class="form-control" id="studentId" required>
            </div>

            <div class="mb-4">
                <label for="name" class="form-label">å§“å</label>
                <input type="text" class="form-control" id="name" required>
            </div>

            <button type="submit" class="btn btn-primary" id="submitBtn">
                <span class="spinner-border" role="status"></span>
                é€å‡ºç°½åˆ°
            </button>
        </form>

        <div id="statusMessage" class="mt-4 text-center fw-bold"></div>
    </div>

    <script>

        const isMobile = /iPhone|iPad|iPod|Android|Mobile/i.test(navigator.userAgent);

        if (isMobile) {
            // å¦‚æœæ˜¯æ‰‹æ©Ÿï¼Œç›´æ¥æ¸…ç©ºç•«é¢ä¸¦é¡¯ç¤ºè­¦å‘Š
            document.body.innerHTML = `
            <div style="display:flex; justify-content:center; align-items:center; height:100vh; background-color:#ffe6e6; flex-direction:column; padding:20px;">
                <h1 style="color:red; font-size:3rem;">ç„¡æ³•ä½¿ç”¨æ‰‹æ©Ÿç°½åˆ°</h1>
                <h2 style="color:#333;">åµæ¸¬åˆ°æ‚¨ä½¿ç”¨è¡Œå‹•è£ç½®ã€‚</h2>
                <h3 style="color:#555;">è«‹ä½¿ç”¨æ•™å®¤é›»è…¦é€²è¡Œç°½åˆ°ã€‚</h3>
            </div>
        `;
            // åœæ­¢åŸ·è¡Œå¾ŒçºŒç¨‹å¼
            throw new Error("Mobile device detected. Execution stopped.");
        }
        // â˜…â˜…â˜… è«‹æ›¿æ›æˆä½ çš„ Google Apps Script ç¶²å€ â˜…â˜…â˜…
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbxqG2sKo9qv6YS_RzvDUnwFoHioZ_GzkGuVOGQbNophkHwJOAEgZu2UZaIDQZBAAAfN/exec';

        // æª¢æŸ¥æœ¬æ©Ÿæ˜¯å¦å·²ç°½åˆ° (LocalStorage é˜²ç¦¦)
        if (localStorage.getItem('hasCheckIn') === 'true') {
            disableForm('âš ï¸ æ­¤è£ç½®å·²å®Œæˆç°½åˆ°ï¼Œè«‹å‹¿é‡è¤‡æäº¤ã€‚');
        }

        document.getElementById('checkinForm').addEventListener('submit', function (e) {
            e.preventDefault();

            const btn = document.getElementById('submitBtn');
            const spinner = document.querySelector('.spinner-border');
            const msg = document.getElementById('statusMessage');

            // é–å®šä»‹é¢
            btn.disabled = true;
            spinner.style.display = 'inline-block';
            btn.innerHTML = '<span class="spinner-border" role="status"></span> åµæ¸¬ç’°å¢ƒä¸­...';
            msg.textContent = '';
            msg.className = '';

            // 1. å–å¾— IP ä½å€ (ä½¿ç”¨ ipify API)
            fetch('https://api.ipify.org?format=json')
                .then(response => response.json())
                .then(ipData => {
                    return ipData.ip;
                })
                .catch(err => {
                    console.warn('ç„¡æ³•å–å¾— IP:', err);
                    return 'ç„¡æ³•å–å¾— IP (å¯èƒ½è¢«é˜»æ“‹)';
                })
                .then(userIP => {
                    // 2. æº–å‚™å‚³é€è³‡æ–™
                    const payload = {
                        password: document.getElementById('password').value,
                        classNo: document.getElementById('classNo').value,
                        seatNo: document.getElementById('seatNo').value,
                        pcNo: document.getElementById('pcNo').value,
                        studentId: document.getElementById('studentId').value,
                        name: document.getElementById('name').value,
                        ip: userIP, // å‚³é€ IP
                        ua: navigator.userAgent // å‚³é€è£ç½®è³‡è¨Š (User Agent)
                    };

                    // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
                    btn.innerHTML = '<span class="spinner-border" role="status"></span> è³‡æ–™å‚³é€ä¸­...';

                    // 3. å‚³é€è‡³ Google Apps Script
                    return fetch(GAS_URL, {
                        method: 'POST',
                        body: JSON.stringify(payload),
                        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                        redirect: 'follow'
                    });
                })
                .then(res => res.json())
                .then(data => {
                    // 4. è™•ç†å¾Œç«¯å›æ‡‰
                    if (data.result === 'success') {
                        // å¯«å…¥ LocalStorage
                        localStorage.setItem('hasCheckIn', 'true');
                        disableForm('ç°½åˆ°æˆåŠŸï¼<br><small class="text-muted">å·²ç´€éŒ„é›»è…¦ç·¨è™Ÿèˆ‡ IP ä½å€</small>');
                        msg.classList.add('text-success');
                    } else if (data.result === 'wrong_password') {
                        throw new Error('å¯†ç¢¼éŒ¯èª¤ï¼Œè«‹é‡æ–°è¼¸å…¥ã€‚');
                    } else if (data.result === 'duplicate_pc' || data.result === 'duplicate_checkin') {
                        throw new Error(`é›»è…¦ç·¨è™Ÿ <u>${data.pcNo}</u> å·²è¢«ä½¿ç”¨ï¼<br>è«‹å‹¿é‡è¤‡ç°½åˆ°æˆ–ä»£ç°½ã€‚`);
                    } else {
                        throw new Error('ç³»çµ±éŒ¯èª¤ï¼š' + (data.error || 'æœªçŸ¥åŸå› '));
                    }
                })
                .catch(err => {
                    // é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
                    msg.innerHTML = err.message;
                    msg.className = 'mt-4 text-center fw-bold text-danger';

                    // å¦‚æœæ˜¯å¯†ç¢¼éŒ¯ï¼Œæ¸…ç©ºå¯†ç¢¼æ¬„ä½
                    if (err.message.includes('å¯†ç¢¼éŒ¯èª¤')) {
                        document.getElementById('password').value = '';
                        document.getElementById('password').focus();
                    }

                    // æ¢å¾©æŒ‰éˆ•
                    btn.disabled = false;
                    btn.innerHTML = 'é€å‡ºç°½åˆ°';
                    spinner.style.display = 'none';
                });
        });

        function disableForm(message) {
            document.getElementById('checkinForm').style.display = 'none';
            const msgDiv = document.getElementById('statusMessage');
            msgDiv.innerHTML = message;
            msgDiv.className = 'mt-4 text-center fw-bold text-success';
            if (message.includes('âš ï¸')) msgDiv.className = 'mt-4 text-center fw-bold text-warning';
        }
    </script>

</body>

</html>