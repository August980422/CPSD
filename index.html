<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>簽到系統</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
        }

        .card {
            max-width: 400px;
            width: 100%;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            border: none;
        }

        .btn-primary {
            width: 100%;
        }

        /* 載入動畫 */
        .spinner-border {
            display: none;
            width: 1rem;
            height: 1rem;
            margin-right: 5px;
        }
    </style>
</head>

<body>

    <div class="card p-4">
        <h3 class="text-center mb-4">社團簽到</h3>

        <form id="checkinForm">
            <div class="mb-3">
                <label for="password" class="form-label text-danger fw-bold">密碼</label>
                <input type="number" class="form-control border-danger" id="password" placeholder="請輸入當日密碼" required>
            </div>
            <hr>
            <div class="row mb-3">
                <div class="col">
                    <label for="classNo" class="form-label">班級</label>
                    <input type="text" class="form-control" id="classNo" placeholder="203" required>
                </div>
                <div class="col">
                    <label for="seatNo" class="form-label">座號</label>
                    <input type="number" class="form-control" id="seatNo" placeholder="15" required>
                </div>
            </div>

            <div class="mb-3">
                <label for="pcNo" class="form-label">電腦編號</label>
                <input type="text" class="form-control" id="pcNo" placeholder="例如：A-01 或 05" required>
            </div>

            <div class="mb-3">
                <label for="studentId" class="form-label">學號</label>
                <input type="text" class="form-control" id="studentId" required>
            </div>

            <div class="mb-3">
                <label for="name" class="form-label">姓名</label>
                <input type="text" class="form-control" id="name" required>
            </div>

            <button type="submit" class="btn btn-primary" id="submitBtn">
                <span class="spinner-border" role="status"></span>
                送出簽到
            </button>
        </form>

        <div id="statusMessage" class="mt-3 text-center fw-bold"></div>
    </div>

    <script>
        // 你的 Apps Script 網址 (請確認網址正確)
        const GAS_URL = 'https://script.google.com/macros/s/AKfycby9f_jlv7pviGuwdOBExjzYX2Vn9XFoL156vT54uVSv8aEAciyirNg7lBWy8ye4co4I/exec';

        // 網頁一載入就檢查是否已簽到
        if (localStorage.getItem('hasCheckIn') === 'true') {
            document.getElementById('checkinForm').style.display = 'none';
            document.getElementById('statusMessage').textContent = '此裝置已完成簽到，請勿重複提交。';
        }

        document.getElementById('checkinForm').addEventListener('submit', function (e) {
            e.preventDefault();

            const btn = document.getElementById('submitBtn');
            const spinner = document.querySelector('.spinner-border');
            const msg = document.getElementById('statusMessage');

            // 鎖定按鈕與顯示動畫
            btn.disabled = true;
            spinner.style.display = 'inline-block';
            msg.textContent = '';
            msg.className = 'mt-3 text-center fw-bold'; // 重置顏色

            // 收集資料 (新增 pcNo)
            const payload = {
                password: document.getElementById('password').value,
                classNo: document.getElementById('classNo').value,
                seatNo: document.getElementById('seatNo').value,
                pcNo: document.getElementById('pcNo').value, // 新增：電腦編號
                studentId: document.getElementById('studentId').value,
                name: document.getElementById('name').value
            };

            fetch(GAS_URL, {
                method: 'POST',
                body: JSON.stringify(payload),
                headers: {
                    'Content-Type': 'text/plain;charset=utf-8'
                },
                redirect: 'follow'
            })
                .then(res => res.json())
                .then(data => {
                    if (data.result === 'success') {
                        // 1. 寫入瀏覽器紀錄
                        localStorage.setItem('hasCheckIn', 'true');

                        // 2. 隱藏表單，顯示成功訊息
                        document.getElementById('checkinForm').style.display = 'none';
                        document.getElementById('statusMessage').innerHTML = '簽到完成！<br>一台裝置僅限簽到一次。';
                    } else if (data.result === 'wrong_password') {
                        msg.textContent = '密碼錯誤，請重新輸入。';
                        msg.classList.add('text-danger');
                        document.getElementById('password').value = '';
                        document.getElementById('password').focus();
                    } else {
                        throw new Error(data.error);
                    }
                })
                .catch(err => {
                    console.error(err);
                    // 寬容處理
                    msg.textContent = '簽到成功 (或網路回應延遲)';
                    msg.classList.add('text-success');
                    document.getElementById('checkinForm').reset();
                })
                .finally(() => {
                    btn.disabled = false;
                    spinner.style.display = 'none';
                });
        });
    </script>

</body>

</html>