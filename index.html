<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>社團簽到系統</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f0f4f8;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif;
        }

        .card {
            max-width: 480px;
            width: 90%;
            border: none;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
        }

        .btn-primary {
            width: 100%;
            padding: 12px;
            font-weight: 600;
            border-radius: 10px;
            transition: all 0.3s ease;
        }

        .btn-primary:disabled {
            background-color: #a0c4ff;
            border-color: #a0c4ff;
        }

        .form-control {
            border-radius: 8px;
            padding: 12px;
            border: 1px solid #ced4da;
        }

        .form-control:focus {
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.15);
        }

        .spinner-border {
            width: 1.2rem;
            height: 1.2rem;
            vertical-align: middle;
            margin-right: 8px;
        }

        #statusMessage {
            min-height: 24px;
            transition: all 0.3s ease;
        }
    </style>
</head>

<body>

    <div class="card p-4">
        <h3 class="text-center mb-4 text-primary fw-bold">社團點名</h3>

        <form id="checkinForm">
            <div class="mb-3">
                <label for="password" class="form-label text-danger fw-bold">密碼</label>
                <input type="tel" class="form-control border-danger" id="password" placeholder="請輸入密碼" required>
            </div>

            <div class="row g-3 mb-3">
                <div class="col-6">
                    <label for="classNo" class="form-label">班級</label>
                    <input type="tel" class="form-control" id="classNo" pattern="\d{3}" placeholder="209" required>
                </div>
                <div class="col-6">
                    <label for="seatNo" class="form-label">座號</label>
                    <input type="tel" class="form-control" id="seatNo" pattern="\d{1,2}" placeholder="07" required>
                </div>
            </div>

            <div class="mb-3">
                <label for="pcNo" class="form-label fw-bold text-success">電腦編號</label>
                <input type="tel" class="form-control border-success" id="pcNo" pattern="\d+" placeholder="00" required>
            </div>

            <div class="mb-3">
                <label for="studentId" class="form-label">學號</label>
                <input type="tel" class="form-control" pattern="\d{6}" id="studentId" required>
            </div>

            <div class="mb-4">
                <label for="name" class="form-label">姓名</label>
                <input type="text" class="form-control" id="name" required>
            </div>

            <button type="submit" class="btn btn-primary" id="submitBtn">
                送出簽到
            </button>
        </form>

        <div id="statusMessage" class="mt-4 text-center fw-bold"></div>
    </div>

    <script>
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbw_7iBSjp2pCLs9_q69lTzSq_1iDsvgC4X4oO4fj7VjQsyQyPVwgzIFZu28hJPIMt_g/exec';

        document.getElementById('checkinForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            const btn = document.getElementById('submitBtn');
            const msg = document.getElementById('statusMessage');

            // 1. 初始化介面狀態
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border" role="status"></span> 處理中...';
            msg.innerHTML = '';
            msg.className = 'mt-4 text-center fw-bold';

            try {
                // 2. 同時執行：取得 GPS 定位與 取得使用者 IP (提升效率)
                // 使用 Promise.all 讓兩個非同步動作並行
                const [position, userIP] = await Promise.all([
                    // 定位 Promise
                    new Promise((resolve, reject) => {
                        if (!navigator.geolocation) {
                            reject(new Error("瀏覽器不支援定位"));
                        }
                        navigator.geolocation.getCurrentPosition(resolve, reject, {
                            enableHighAccuracy: true,
                            timeout: 10000
                        });
                    }),
                    // IP Promise
                    fetch('https://api.ipify.org?format=json')
                        .then(res => res.json())
                        .then(data => data.ip)
                        .catch(() => '無法取得 IP')
                ]);

                // 3. 整理傳送資料
                const payload = {
                    password: document.getElementById('password').value,
                    classNo: document.getElementById('classNo').value,
                    seatNo: document.getElementById('seatNo').value,
                    pcNo: document.getElementById('pcNo').value,
                    studentId: document.getElementById('studentId').value,
                    name: document.getElementById('name').value,
                    ip: userIP,
                    ua: navigator.userAgent,
                    lat: position.coords.latitude,
                    lng: position.coords.longitude
                };

                btn.innerHTML = '<span class="spinner-border" role="status"></span> 資料上傳中...';

                // 4. 傳送至 Google Apps Script
                const response = await fetch(GAS_URL, {
                    method: 'POST',
                    body: JSON.stringify(payload),
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    redirect: 'follow'
                });

                if (!response.ok) throw new Error('伺服器連線失敗');

                const data = await response.json();

                // 5. 根據後端回傳結果處理 UI
                if (data.result === 'success') {
                    showSuccess('簽到成功！');
                } else if (data.result === 'wrong_password') {
                    throw new Error('密碼錯誤，請重新確認。');
                } else if (data.result === 'duplicate_pc') {
                    throw new Error(`電腦編號 ${data.pcNo} 已經簽到過了！`);
                } else {
                    throw new Error('發生錯誤：' + (data.error || '未知原因'));
                }

            } catch (error) {
                // 處理所有可能的錯誤 (GPS 失敗、網路失敗、密碼錯誤)
                let errorText = error.message;

                // 針對 Geolocation 錯誤碼進行友善提示
                if (error.code === 1) errorText = "請允許瀏覽器存取 GPS 定位，否則無法簽到。";
                if (error.code === 3) errorText = "定位逾時，請檢查網路或重試。";

                handleError(errorText);
            }
        });

        function showSuccess(message) {
            document.getElementById('checkinForm').style.display = 'none';
            const msgDiv = document.getElementById('statusMessage');
            msgDiv.innerHTML = message;
            msgDiv.className = 'mt-4 text-center fw-bold text-success';
        }

        function handleError(message) {
            const btn = document.getElementById('submitBtn');
            const msg = document.getElementById('statusMessage');

            msg.innerHTML = message;
            msg.className = 'mt-4 text-center fw-bold text-danger';

            // 如果是密碼錯，重設密碼欄位
            if (message.includes('密碼')) {
                document.getElementById('password').value = '';
                document.getElementById('password').focus();
            }

            // 恢復按鈕狀態
            btn.disabled = false;
            btn.innerHTML = '重新送出簽到';
        }
    </script>

</body>

</html>